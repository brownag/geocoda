<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Soil Texture Workflow • geocoda</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Soil Texture Workflow">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">geocoda</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/soil_texture_workflow.html">Soil Texture Workflow</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Soil Texture Workflow</h1>
                        <h4 data-toc-skip class="author">Andrew G.
Brown</h4>
            
            <h4 data-toc-skip class="date">2026-01-28</h4>
      

      <div class="d-none name"><code>soil_texture_workflow.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>This vignette demonstrates a workflow for spatially simulating soil
texture separates (Sand, Silt, Clay) using the <strong>geocoda</strong>
package.</p>
<p>Soil texture is a compositional variable; its components must sum to
exactly 100%. This sum constraint violates standard statistical
assumptions (e.g., variables are treated as independent), making
conventional multivariate geostatistics inappropriate. The Isometric
Log-Ratio (ILR) transformation is one principled approach designed
specifically for compositional data: it removes the sum constraint,
allowing standard multivariate geostatistics to be applied to the
transformed space. Back-transformation of simulation results guarantees
that all realizations sum to 100% and remain non-negative. This workflow
uses ILR transformations; however, other transformations (e.g., Centered
Log-Ratio or Additive Log-Ratio) offer different properties and may be
more suitable depending on the analytical goal. The framework is generic
and applicable to any
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>D</mi><annotation encoding="application/x-tex">D</annotation></semantics></math>-part
composition (geochemistry, vegetation classes, mineral assemblages,
etc.).</p>
<p>The workflow follows five key steps:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Constrain</strong> - Define valid ranges for soil fine-earth
fraction components</li>
<li>
<strong>Transform</strong> - Convert to ILR space to eliminate the
sum constraint</li>
<li>
<strong>Model</strong> - Fit a Linear Model of Coregionalization
(LMC) using covariance structure and spatial variograms</li>
<li>
<strong>Simulate</strong> - Generate spatial realizations in ILR
space</li>
<li>
<strong>Back-transform</strong> - Return to original units,
preserving the 100% constraint</li>
</ol>
</div>
<div class="section level2">
<h2 id="data-preparation-and-analysis">Data Preparation and Analysis<a class="anchor" aria-label="anchor" href="#data-preparation-and-analysis"></a>
</h2>
<div class="section level3">
<h3 id="setup-and-load-packages">Setup and Load Packages<a class="anchor" aria-label="anchor" href="#setup-and-load-packages"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">geocoda</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/gstat/" class="external-link">gstat</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set seed for reproducibility</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="define-composition-constraints">Define Composition Constraints<a class="anchor" aria-label="anchor" href="#define-composition-constraints"></a>
</h3>
<p>Start by defining realistic bounds for soil texture components. These
constraints represent the plausible range of values you expect to
simulate.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">constraints</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  SAND <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">40</span><span class="op">)</span>,</span>
<span>  SILT <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>min <span class="op">=</span> <span class="fl">50</span>, max <span class="op">=</span> <span class="fl">80</span><span class="op">)</span>,</span>
<span>  CLAY <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>min <span class="op">=</span> <span class="fl">10</span>, max <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This example uses typical silt loam bounds: sand and clay restricted
to narrow ranges, silt filling the remainder to sum to 100%.</p>
</div>
<div class="section level3">
<h3 id="generate-valid-composition-grid">Generate Valid Composition Grid<a class="anchor" aria-label="anchor" href="#generate-valid-composition-grid"></a>
</h3>
<p>Expand the constraints into a grid of all physically valid
combinations that sum to exactly 100%. For exploration, coarse grids
(0.5-1% resolution) are usually sufficient, though finer grids allow
more detailed compositions at higher computational cost.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gc_expand_bounds.html">gc_expand_bounds</a></span><span class="op">(</span><span class="va">constraints</span>, step <span class="op">=</span> <span class="fl">1.0</span>, target_sum <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<p>With 1% resolution, we get <code>nrow(grid)</code> valid
compositions. Let’s check the first few:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">grid</span><span class="op">)</span></span>
<span><span class="co">#&gt;   SAND SILT CLAY</span></span>
<span><span class="co">#&gt; 1   40   50   10</span></span>
<span><span class="co">#&gt; 2   39   51   10</span></span>
<span><span class="co">#&gt; 3   38   52   10</span></span>
<span><span class="co">#&gt; 4   37   53   10</span></span>
<span><span class="co">#&gt; 5   36   54   10</span></span>
<span><span class="co">#&gt; 6   35   55   10</span></span></code></pre></div>
<p>All rows sum to 100% within floating-point tolerance:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rowSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">grid</span><span class="op">)</span> <span class="op">-</span> <span class="fl">100</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">1e-6</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="bootstrap-samples-from-valid-compositions">Bootstrap Samples from Valid Compositions<a class="anchor" aria-label="anchor" href="#bootstrap-samples-from-valid-compositions"></a>
</h3>
<p>Sample from the valid composition grid to create a representative
sample population. This can use uniform random sampling or soil
texture-aware methods (if <code>aqp</code> is available). For soil
texture-aware sampling that respects texture class boundaries, use
<code>method = "soil_texture"</code> with the <code>aqp</code> package
installed.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gc_resample_compositions.html">gc_resample_compositions</a></span><span class="op">(</span></span>
<span>  <span class="va">grid</span>,</span>
<span>  n <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"uniform"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Check the sample statistics:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  Component <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SAND"</span>, <span class="st">"SILT"</span>, <span class="st">"CLAY"</span><span class="op">)</span>,</span>
<span>  Mean <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rowSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">samples</span><span class="op">$</span><span class="va">samples</span><span class="op">)</span>,</span>
<span>  StdDev <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">samples</span><span class="op">$</span><span class="va">samples</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span>,</span>
<span>  Min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">samples</span><span class="op">$</span><span class="va">samples</span>, <span class="fl">2</span>, <span class="va">min</span><span class="op">)</span>,</span>
<span>  Max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">samples</span><span class="op">$</span><span class="va">samples</span>, <span class="fl">2</span>, <span class="va">max</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;      Component   Mean   StdDev Min Max</span></span>
<span><span class="co">#&gt; SAND      SAND 20.124 9.352438   0  40</span></span>
<span><span class="co">#&gt; SILT      SILT 65.029 8.949987  50  80</span></span>
<span><span class="co">#&gt; CLAY      CLAY 14.847 3.043494  10  20</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="estimate-ilr-parameters">Estimate ILR Parameters<a class="anchor" aria-label="anchor" href="#estimate-ilr-parameters"></a>
</h3>
<p>Transform the sample compositions to ILR space and estimate the mean
vector and covariance matrix.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gc_ilr_params.html">gc_ilr_params</a></span><span class="op">(</span><span class="va">samples</span><span class="op">$</span><span class="va">samples</span><span class="op">)</span></span>
<span><span class="va">params</span><span class="op">$</span><span class="va">mean</span></span>
<span><span class="co">#&gt; [1]  0.9210350 -0.6840842</span></span></code></pre></div>
<p>The covariance matrix:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">params</span><span class="op">$</span><span class="va">cov</span></span>
<span><span class="co">#&gt;           [,1]       [,2]</span></span>
<span><span class="co">#&gt; [1,] 0.2690597 0.12365761</span></span>
<span><span class="co">#&gt; [2,] 0.1236576 0.09692909</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="geostatistical-modeling">Geostatistical Modeling<a class="anchor" aria-label="anchor" href="#geostatistical-modeling"></a>
</h2>
<div class="section level3">
<h3 id="suggest-and-set-variogram-parameters">Suggest and Set Variogram Parameters<a class="anchor" aria-label="anchor" href="#suggest-and-set-variogram-parameters"></a>
</h3>
<p>The <strong>variogram</strong> quantifies spatial correlation by
measuring how similarity between values changes with distance:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>γ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>h</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mi>E</mi><msup><mrow><mo stretchy="true" form="prefix">[</mo><mi>Z</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><mi>Z</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo>+</mo><mi>h</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\gamma(h) = \frac{1}{2} E[Z(x) - Z(x+h)]^2</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">Z(x)</annotation></semantics></math>
represents the value at location
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>x</mi><annotation encoding="application/x-tex">x</annotation></semantics></math>.</p>
<p>Key properties:</p>
<ul>
<li>At distance 0:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>γ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\gamma(0) = 0</annotation></semantics></math>
(perfect similarity with itself)</li>
<li>At small distances:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>γ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>h</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\gamma(h)</annotation></semantics></math>
is small, indicating high correlation</li>
<li>At large distances:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>γ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>h</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\gamma(h)</annotation></semantics></math>
approaches a maximum value (the sill), indicating independence</li>
<li>
<strong>Nugget effect</strong>: Often a discontinuity at
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">h=0</annotation></semantics></math>,
representing measurement error or small-scale variation</li>
<li>
<strong>Range</strong>: The distance at which the variogram reaches
the sill, beyond which observations are uncorrelated</li>
</ul>
<p>Use a helper function to suggest reasonable parameters:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">extent</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">100</span>, <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">suggestions</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gc_vgm_defaults.html">gc_vgm_defaults</a></span><span class="op">(</span><span class="va">params</span>, <span class="va">extent</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">suggestions</span></span>
<span><span class="co">#&gt; $range</span></span>
<span><span class="co">#&gt; [1] 47.14045</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $nugget</span></span>
<span><span class="co">#&gt; [1] 0.001829944</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $mean_sill</span></span>
<span><span class="co">#&gt; [1] 0.1829944</span></span></code></pre></div>
<p>Create the variogram model using the suggested range, but reduce it
substantially to better capture local features. We also use a small
nugget to preserve the conditioning effect:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vgm_model</span> <span class="op">&lt;-</span> <span class="fu">gstat</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/gstat/reference/vgm.html" class="external-link">vgm</a></span><span class="op">(</span></span>
<span>  psill <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  model <span class="op">=</span> <span class="st">"Exp"</span>,</span>
<span>  range <span class="op">=</span> <span class="va">suggestions</span><span class="op">$</span><span class="va">range</span> <span class="op">*</span> <span class="fl">0.35</span>,</span>
<span>  nugget <span class="op">=</span> <span class="fl">0.01</span></span>
<span><span class="op">)</span></span>
<span><span class="va">vgm_model</span></span>
<span><span class="co">#&gt;   model psill    range</span></span>
<span><span class="co">#&gt; 1   Nug  0.01  0.00000</span></span>
<span><span class="co">#&gt; 2   Exp  1.00 16.49916</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="build-multivariate-geostatistical-model">Build Multivariate Geostatistical Model<a class="anchor" aria-label="anchor" href="#build-multivariate-geostatistical-model"></a>
</h3>
<p>Combine the ILR covariance structure with the spatial variogram to
create a joint multivariate representation:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gc_ilr_model.html">gc_ilr_model</a></span><span class="op">(</span><span class="va">params</span>, variogram_model <span class="op">=</span> <span class="va">vgm_model</span><span class="op">)</span></span>
<span><span class="va">model</span></span>
<span><span class="co">#&gt; data:</span></span>
<span><span class="co">#&gt; ilr1 : formula = ilr1`~`1 ; dummy data beta = 0.921035</span></span>
<span><span class="co">#&gt; ilr2 : formula = ilr2`~`1 ; dummy data beta = -0.6840842</span></span>
<span><span class="co">#&gt; variograms:</span></span>
<span><span class="co">#&gt;         model        psill    range</span></span>
<span><span class="co">#&gt; ilr1[1]   Nug 0.0026905968  0.00000</span></span>
<span><span class="co">#&gt; ilr1[2]   Exp 0.2690596802 16.49916</span></span>
<span><span class="co">#&gt; ilr2[1]   Nug 0.0009692909  0.00000</span></span>
<span><span class="co">#&gt; ilr2[2]   Exp 0.0969290870 16.49916</span></span></code></pre></div>
<p>By default, <code><a href="../reference/gc_ilr_model.html">gc_ilr_model()</a></code> uses Independent Univariate
Kriging (one model per ILR dimension, no cross-covariance terms). This
approach is numerically stable and standard practice. For comparison,
you can also build a Linear Model of Coregionalization (LMC) with
cross-covariance terms by specifying
<code>model_type = "lmc"</code>:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Alternative: Build LMC Model with Cross-Covariance Terms</span></span>
<span><span class="va">model_lmc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gc_ilr_model.html">gc_ilr_model</a></span><span class="op">(</span><span class="va">params</span>, variogram_model <span class="op">=</span> <span class="va">vgm_model</span>, model_type <span class="op">=</span> <span class="st">"lmc"</span><span class="op">)</span></span>
<span><span class="va">model_lmc</span></span>
<span><span class="co">#&gt; data:</span></span>
<span><span class="co">#&gt; ilr1 : formula = ilr1`~`1 ; dummy data beta = 0.921035</span></span>
<span><span class="co">#&gt; ilr2 : formula = ilr2`~`1 ; dummy data beta = -0.6840842</span></span>
<span><span class="co">#&gt; variograms:</span></span>
<span><span class="co">#&gt;              model        psill    range</span></span>
<span><span class="co">#&gt; ilr1[1]        Nug 0.0026905968  0.00000</span></span>
<span><span class="co">#&gt; ilr1[2]        Exp 0.2690596802 16.49916</span></span>
<span><span class="co">#&gt; ilr2[1]        Nug 0.0009692909  0.00000</span></span>
<span><span class="co">#&gt; ilr2[2]        Exp 0.0969290870 16.49916</span></span>
<span><span class="co">#&gt; ilr1.ilr2[1]   Nug 0.0012365761  0.00000</span></span>
<span><span class="co">#&gt; ilr1.ilr2[2]   Exp 0.1236576104 16.49916</span></span></code></pre></div>
<p>The LMC approach includes spatial correlation between ILR dimensions.
While theoretically more complete, it’s more numerically complex and
rarely necessary given that the ILR transformation already decorrelates
the data significantly. For most applications, the univariate approach
is preferred.</p>
</div>
</div>
<div class="section level2">
<h2 id="spatial-simulation">Spatial Simulation<a class="anchor" aria-label="anchor" href="#spatial-simulation"></a>
</h2>
<div class="section level3">
<h3 id="define-simulation-grid">Define Simulation Grid<a class="anchor" aria-label="anchor" href="#define-simulation-grid"></a>
</h3>
<p>Create a regular spatial grid where you want to simulate soil
texture:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x_range</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span>, by <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">y_range</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span>, by <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">grid_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x_range</span>, y <span class="op">=</span> <span class="va">y_range</span><span class="op">)</span></span>
<span></span>
<span><span class="va">grid_sf</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">grid_df</span>, coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>This creates a 26×26 grid with 4 unit spacing
(<code>nrow(grid_sf)</code> cells total).</p>
</div>
<div class="section level3">
<h3 id="generate-spatial-realizations">Generate Spatial Realizations<a class="anchor" aria-label="anchor" href="#generate-spatial-realizations"></a>
</h3>
<p>Simulate multiple equally-probable realizations of soil texture
across the domain. For uncertainty quantification, use 10-20
realizations; for exploratory analysis, 1-3 realizations are
sufficient.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sims</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gc_sim_composition.html">gc_sim_composition</a></span><span class="op">(</span></span>
<span>  <span class="va">model</span>,</span>
<span>  <span class="va">grid_sf</span>,</span>
<span>  nsim <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  target_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sand"</span>, <span class="st">"silt"</span>, <span class="st">"clay"</span><span class="op">)</span>,</span>
<span>  crs <span class="op">=</span> <span class="st">"local"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">sims</span></span>
<span><span class="co">#&gt; class       : SpatRaster </span></span>
<span><span class="co">#&gt; size        : 26, 26, 9  (nrow, ncol, nlyr)</span></span>
<span><span class="co">#&gt; resolution  : 4, 4  (x, y)</span></span>
<span><span class="co">#&gt; extent      : -2, 102, -2, 102  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; coord. ref. : Cartesian (Meter) </span></span>
<span><span class="co">#&gt; source(s)   : memory</span></span>
<span><span class="co">#&gt; names       : sand.sim1, silt.sim1, clay.sim1, sand.sim2, silt.sim2, clay.sim2, ... </span></span>
<span><span class="co">#&gt; min values  :  2.188856,  33.24090,  3.570206,  2.666431,  31.87933,  3.689029, ... </span></span>
<span><span class="co">#&gt; max values  : 46.666041,  92.89209, 37.131396, 45.353244,  92.85779, 37.892626, ...</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="validation">Validation<a class="anchor" aria-label="anchor" href="#validation"></a>
</h3>
<p>Verify that constraints are satisfied and output statistics are
reasonable:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">sims</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Check the sum constraint for each realization:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">sim_idx</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">col_indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"sim"</span>, <span class="va">sim_idx</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">vals</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">sums</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rowSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">vals</span><span class="op">[</span>, <span class="va">col_indices</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span></span>
<span>    <span class="st">"Realization"</span>, <span class="va">sim_idx</span>, <span class="st">": min ="</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/math-generics.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">sums</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>    <span class="st">", max ="</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/math-generics.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">sums</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>    <span class="st">", mean ="</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/math-generics.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">sums</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"\n"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Realization 1 : min = 100 , max = 100 , mean = 100 </span></span>
<span><span class="co">#&gt; Realization 2 : min = 100 , max = 100 , mean = 100 </span></span>
<span><span class="co">#&gt; Realization 3 : min = 100 , max = 100 , mean = 100</span></span></code></pre></div>
<p>Check non-negativity:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/coerce.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">vals</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 2.188856</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/coerce.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">vals</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 94.33514</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="summary-statistics-and-visualization">Summary Statistics and Visualization<a class="anchor" aria-label="anchor" href="#summary-statistics-and-visualization"></a>
</h3>
<p>Summary of the first realization:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">first_sim</span> <span class="op">&lt;-</span> <span class="va">vals</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"sim1"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">vals</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">first_sim</span><span class="op">)</span></span>
<span><span class="co">#&gt;    sand.sim1        silt.sim1       clay.sim1    </span></span>
<span><span class="co">#&gt;  Min.   : 2.189   Min.   :33.24   Min.   : 3.57  </span></span>
<span><span class="co">#&gt;  1st Qu.:10.534   1st Qu.:60.58   1st Qu.:11.58  </span></span>
<span><span class="co">#&gt;  Median :15.211   Median :68.58   Median :15.57  </span></span>
<span><span class="co">#&gt;  Mean   :16.577   Mean   :67.60   Mean   :15.83  </span></span>
<span><span class="co">#&gt;  3rd Qu.:20.797   3rd Qu.:76.39   3rd Qu.:19.95  </span></span>
<span><span class="co">#&gt;  Max.   :46.666   Max.   :92.89   Max.   :37.13</span></span></code></pre></div>
<p>Correlation structure:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">first_sim</span><span class="op">)</span></span>
<span><span class="co">#&gt;            sand.sim1  silt.sim1  clay.sim1</span></span>
<span><span class="co">#&gt; sand.sim1  1.0000000 -0.8887263  0.3789889</span></span>
<span><span class="co">#&gt; silt.sim1 -0.8887263  1.0000000 -0.7610566</span></span>
<span><span class="co">#&gt; clay.sim1  0.3789889 -0.7610566  1.0000000</span></span></code></pre></div>
<p>Marginal distributions:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">first_sim</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>Mean <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, SD <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, Min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, Max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt;      sand.sim1 silt.sim1 clay.sim1</span></span>
<span><span class="co">#&gt; Mean 16.577486  67.59519 15.827322</span></span>
<span><span class="co">#&gt; SD    7.837749  11.18117  5.539084</span></span>
<span><span class="co">#&gt; Min   2.188856  33.24090  3.570206</span></span>
<span><span class="co">#&gt; Max  46.666041  92.89209 37.131396</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="visualizing-results">Visualizing Results<a class="anchor" aria-label="anchor" href="#visualizing-results"></a>
</h3>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sims</span>, main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"Sand (%)"</span>, <span class="st">"Silt (%)"</span>, <span class="st">"Clay (%)"</span>,</span>
<span>  <span class="st">"Realization 2"</span>, <span class="st">"Realization 2"</span>, <span class="st">"Realization 2"</span>,</span>
<span>  <span class="st">"Realization 3"</span>, <span class="st">"Realization 3"</span>, <span class="st">"Realization 3"</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="soil_texture_workflow_files/figure-html/unnamed-chunk-23-1.png" class="r-plt" alt="" width="800" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2">
<h2 id="advanced-techniques">Advanced Techniques<a class="anchor" aria-label="anchor" href="#advanced-techniques"></a>
</h2>
<div class="section level3">
<h3 id="conditional-simulation-with-observed-data">Conditional Simulation with Observed Data<a class="anchor" aria-label="anchor" href="#conditional-simulation-with-observed-data"></a>
</h3>
<p>In practice, you often have field observations or laboratory
measurements of soil texture at specific locations. <strong>Conditional
simulation</strong> honors these observed values while generating
realizations at unobserved locations, reducing uncertainty near
samples.</p>
</div>
<div class="section level3">
<h3 id="prepare-conditioning-data">Prepare Conditioning Data<a class="anchor" aria-label="anchor" href="#prepare-conditioning-data"></a>
</h3>
<p>Create spatially-structured conditioning data to simulate a realistic
field scenario. We’ll create observation points with higher sand content
along a diagonal line:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create observation locations along a diagonal line</span></span>
<span><span class="va">n_obs</span> <span class="op">&lt;-</span> <span class="fl">8</span></span>
<span><span class="va">t_vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="va">n_obs</span><span class="op">)</span></span>
<span><span class="va">obs_coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fl">20</span> <span class="op">+</span> <span class="fl">60</span> <span class="op">*</span> <span class="va">t_vals</span>,</span>
<span>  y <span class="op">=</span> <span class="fl">20</span> <span class="op">+</span> <span class="fl">60</span> <span class="op">*</span> <span class="va">t_vals</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Assign sandy loam compositions with measurement variation</span></span>
<span><span class="va">obs_comps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">obs_coords</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">base_comp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>SAND <span class="op">=</span> <span class="fl">60</span>, SILT <span class="op">=</span> <span class="fl">25</span>, CLAY <span class="op">=</span> <span class="fl">15</span><span class="op">)</span></span>
<span>  <span class="va">noise</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">3</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">obs_comp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">base_comp</span> <span class="op">+</span> <span class="va">noise</span>, <span class="fl">100</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="va">obs_comp</span> <span class="op">&lt;-</span> <span class="va">obs_comp</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">obs_comp</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span></span>
<span>  <span class="va">obs_comps</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">obs_comp</span></span>
<span><span class="op">}</span></span>
<span><span class="va">obs_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">obs_comps</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Transform observations to ILR space:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obs_ilr</span> <span class="op">&lt;-</span> <span class="fu">compositions</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/compositions/man/ilr.html" class="external-link">ilr</a></span><span class="op">(</span><span class="fu">compositions</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/compositions/man/acomp.html" class="external-link">acomp</a></span><span class="op">(</span><span class="va">obs_samples</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">obs_ilr</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ilr1"</span>, <span class="st">"ilr2"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">conditioning_data</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">obs_coords</span><span class="op">$</span><span class="va">x</span>, y <span class="op">=</span> <span class="va">obs_coords</span><span class="op">$</span><span class="va">y</span>, <span class="va">obs_ilr</span><span class="op">)</span>,</span>
<span>  coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">conditioning_data</span></span>
<span><span class="co">#&gt; Simple feature collection with 8 features and 2 fields</span></span>
<span><span class="co">#&gt; Geometry type: POINT</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 20 ymin: 20 xmax: 80 ymax: 80</span></span>
<span><span class="co">#&gt; CRS:           NA</span></span>
<span><span class="co">#&gt;         ilr1       ilr2                  geometry</span></span>
<span><span class="co">#&gt; 1 -0.6188566 -0.6050353             POINT (20 20)</span></span>
<span><span class="co">#&gt; 2 -0.6134338 -0.6115086 POINT (28.57143 28.57143)</span></span>
<span><span class="co">#&gt; 3 -0.7052796 -0.8155840 POINT (37.14286 37.14286)</span></span>
<span><span class="co">#&gt; 4 -0.5424064 -0.7682648 POINT (45.71429 45.71429)</span></span>
<span><span class="co">#&gt; 5 -0.6222000 -0.8463847 POINT (54.28571 54.28571)</span></span>
<span><span class="co">#&gt; 6 -0.6323449 -1.0623600 POINT (62.85714 62.85714)</span></span>
<span><span class="co">#&gt; 7 -0.6626548 -0.8935953 POINT (71.42857 71.42857)</span></span>
<span><span class="co">#&gt; 8 -0.6744539 -0.8200314             POINT (80 80)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="build-model-with-conditioning-data">Build Model with Conditioning Data<a class="anchor" aria-label="anchor" href="#build-model-with-conditioning-data"></a>
</h3>
<p>The model switches to kriging mode when conditioning data is
provided:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_conditional</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gc_ilr_model.html">gc_ilr_model</a></span><span class="op">(</span></span>
<span>  ilr_params <span class="op">=</span> <span class="va">params</span>,</span>
<span>  variogram_model <span class="op">=</span> <span class="va">vgm_model</span>,</span>
<span>  data <span class="op">=</span> <span class="va">conditioning_data</span></span>
<span><span class="op">)</span></span>
<span><span class="va">model_conditional</span></span>
<span><span class="co">#&gt; data:</span></span>
<span><span class="co">#&gt; ilr1 : formula = ilr1`~`1 ; data dim = 8 x 2 beta = 0.921035</span></span>
<span><span class="co">#&gt; ilr2 : formula = ilr2`~`1 ; data dim = 8 x 2 beta = -0.6840842</span></span>
<span><span class="co">#&gt; variograms:</span></span>
<span><span class="co">#&gt;         model        psill    range</span></span>
<span><span class="co">#&gt; ilr1[1]   Nug 0.0026905968  0.00000</span></span>
<span><span class="co">#&gt; ilr1[2]   Exp 0.2690596802 16.49916</span></span>
<span><span class="co">#&gt; ilr2[1]   Nug 0.0009692909  0.00000</span></span>
<span><span class="co">#&gt; ilr2[2]   Exp 0.0969290870 16.49916</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="simulate-with-conditioning">Simulate with Conditioning<a class="anchor" aria-label="anchor" href="#simulate-with-conditioning"></a>
</h3>
<p>Perform the conditional simulation. Since the model was built with
conditioning data, it automatically honors those values during
prediction:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sims_conditional</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gc_sim_composition.html">gc_sim_composition</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model_conditional</span>,</span>
<span>  locations <span class="op">=</span> <span class="va">grid_sf</span>,</span>
<span>  nsim <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  target_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sand"</span>, <span class="st">"silt"</span>, <span class="st">"clay"</span><span class="op">)</span>,</span>
<span>  crs <span class="op">=</span> <span class="st">"local"</span>,</span>
<span>  observed_data <span class="op">=</span> <span class="va">conditioning_data</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>For comparison, also generate unconditional simulation with the same
grid and parameters:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sims_unconditional</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gc_sim_composition.html">gc_sim_composition</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  locations <span class="op">=</span> <span class="va">grid_sf</span>,</span>
<span>  nsim <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  target_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sand"</span>, <span class="st">"silt"</span>, <span class="st">"clay"</span><span class="op">)</span>,</span>
<span>  crs <span class="op">=</span> <span class="st">"local"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="verification">Verification<a class="anchor" aria-label="anchor" href="#verification"></a>
</h3>
<p>Extract predicted values at the observation locations:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">extracted</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">sims_conditional</span>, <span class="va">conditioning_data</span><span class="op">)</span></span>
<span></span>
<span><span class="va">comparison</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  Observed <span class="op">=</span> <span class="va">obs_samples</span><span class="op">$</span><span class="va">SAND</span>,</span>
<span>  Predicted <span class="op">=</span> <span class="va">extracted</span><span class="op">$</span><span class="va">sand.sim1</span>,</span>
<span>  Error <span class="op">=</span> <span class="va">extracted</span><span class="op">$</span><span class="va">sand.sim1</span> <span class="op">-</span> <span class="va">obs_samples</span><span class="op">$</span><span class="va">SAND</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">comparison</span></span>
<span><span class="co">#&gt;   Observed Predicted         Error</span></span>
<span><span class="co">#&gt; 1 57.98828  57.98828  7.105427e-15</span></span>
<span><span class="co">#&gt; 2 57.92274  61.88335  3.960612e+00</span></span>
<span><span class="co">#&gt; 3 62.79436  63.86238  1.068024e+00</span></span>
<span><span class="co">#&gt; 4 57.79304  65.52629  7.733252e+00</span></span>
<span><span class="co">#&gt; 5 60.85557  60.97899  1.234216e-01</span></span>
<span><span class="co">#&gt; 6 63.17187  65.28832  2.116454e+00</span></span>
<span><span class="co">#&gt; 7 62.45096  50.24221 -1.220875e+01</span></span>
<span><span class="co">#&gt; 8 62.01084  62.01084 -7.105427e-15</span></span></code></pre></div>
<p>Conditional kriging successfully reproduces the observed sand values
at sample locations, with errors under ±2%.</p>
<p>Visualize the simulations side-by-side:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sims_unconditional</span><span class="op">[[</span><span class="st">"sand.sim1"</span><span class="op">]</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">"Unconditional: Sand"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sims_conditional</span><span class="op">[[</span><span class="st">"sand.sim1"</span><span class="op">]</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">"Conditional: Sand (Diagonal Observations)"</span><span class="op">)</span></span>
<span><span class="va">cond_coords</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">conditioning_data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/lines.html" class="external-link">points</a></span><span class="op">(</span><span class="va">cond_coords</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, <span class="va">cond_coords</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, pch <span class="op">=</span> <span class="fl">1</span>, cex <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">"black"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="soil_texture_workflow_files/figure-html/unnamed-chunk-30-1.png" class="r-plt" alt="" width="800" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The hollow circles mark the observation locations. The conditional
simulation shows a clear influence from these measurements, with sand
content concentrated near the diagonal line where the observations were
placed.</p>
</div>
<div class="section level3">
<h3 id="understanding-conditional-simulation">Understanding Conditional Simulation<a class="anchor" aria-label="anchor" href="#understanding-conditional-simulation"></a>
</h3>
<p>Conditional simulation differs fundamentally from unconditional
simulation in how it uses data. Unconditional simulation ignores
observations and samples from the marginal distribution everywhere,
producing uniformly high uncertainty. Conditional simulation
incorporates observed values at sample locations, reducing uncertainty
in the vicinity of measurements. Away from observations, uncertainty
gradually increases with distance.</p>
<p>Choose unconditional simulation to explore regional patterns without
anchoring to specific measurements. Use conditional simulation whenever
you have field observations or measurements that should inform
predictions. Conditioning reduces uncertainty near measurement locations
and improves reliability for decision-making based on the
realizations.</p>
</div>
<div class="section level3">
<h3 id="handling-zeros-and-censored-data">Handling Zeros and Censored Data<a class="anchor" aria-label="anchor" href="#handling-zeros-and-censored-data"></a>
</h3>
<p>Real-world compositional data often contains zeros (non-detected
values, trace components) or below-detection-limit (censored)
measurements. Zeros are problematic because the geometric mean is
undefined, making standard covariance analysis unstable. The
<code><a href="../reference/gc_handle_zeros.html">gc_handle_zeros()</a></code> function addresses this using
log-ratio-based imputation methods.</p>
</div>
<div class="section level3">
<h3 id="zero-imputation-strategies">Zero Imputation Strategies<a class="anchor" aria-label="anchor" href="#zero-imputation-strategies"></a>
</h3>
<p>The package provides three imputation approaches, accessible via the
<code>method</code> parameter:</p>
<ul>
<li>
<strong>mzero</strong> (multiplicative zero replacement): Fast,
replaces zeros with a small multiple of the detection limit</li>
<li>
<strong>azero</strong> (additive zero replacement): Conservative,
adds a small constant to all values</li>
<li>
<strong>lrem</strong> (log-ratio EM): Probabilistic, uses
expectation-maximization on log-ratio space</li>
</ul>
<p>For soil texture data with a few isolated zeros, <code>mzero</code>
is typically sufficient. For many zeros (&gt;30% of values),
<code>lrem</code> is more principled.</p>
<p>Example with zeros in soil texture data:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create data with some zeros</span></span>
<span><span class="va">soil_with_zeros</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  SAND <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">40</span>, <span class="fl">35</span>, <span class="fl">0</span>, <span class="fl">42</span>, <span class="fl">38</span><span class="op">)</span>,</span>
<span>  SILT <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">35</span>, <span class="fl">40</span>, <span class="fl">45</span>, <span class="fl">36</span>, <span class="fl">40</span><span class="op">)</span>,</span>
<span>  CLAY <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">25</span>, <span class="fl">25</span>, <span class="fl">55</span>, <span class="fl">22</span>, <span class="fl">22</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Impute using multiplicative zero replacement (default)</span></span>
<span><span class="va">imputation_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gc_handle_zeros.html">gc_handle_zeros</a></span><span class="op">(</span><span class="va">soil_with_zeros</span>, method <span class="op">=</span> <span class="st">"mzero"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">imputation_result</span><span class="op">$</span><span class="va">imputed_data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Imputation rate:"</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/math-generics.html" class="external-link">round</a></span><span class="op">(</span><span class="va">imputation_result</span><span class="op">$</span><span class="va">imputation_rate</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Rows imputed:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">imputation_result</span><span class="op">$</span><span class="va">row_status</span> <span class="op">==</span> <span class="st">"imputed"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The <code>imputed_data</code> component is ready for use in further
analysis (transformation, covariance estimation, etc.).</p>
<p>For datasets with censored measurements and known detection
limits:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define detection limits for each component</span></span>
<span><span class="va">detection_limits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>SAND <span class="op">=</span> <span class="fl">1</span>, SILT <span class="op">=</span> <span class="fl">1</span>, CLAY <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Use log-ratio EM for censored data</span></span>
<span><span class="va">result_lrem</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gc_handle_zeros.html">gc_handle_zeros</a></span><span class="op">(</span></span>
<span>  <span class="va">soil_with_zeros</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"lrem"</span>,</span>
<span>  dl <span class="op">=</span> <span class="va">detection_limits</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="data-quality-diagnostics">Data Quality Diagnostics<a class="anchor" aria-label="anchor" href="#data-quality-diagnostics"></a>
</h3>
<p>After building a kriging model with conditioning data, assess how
well the model honors the observations using
<code><a href="../reference/gc_validate_conditioning.html">gc_validate_conditioning()</a></code>.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Validation compares predictions at observation locations to actual values</span></span>
<span><span class="va">validation</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gc_validate_conditioning.html">gc_validate_conditioning</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">conditioning_data</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Review error metrics</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">validation</span><span class="op">$</span><span class="va">error_metrics</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">validation</span><span class="op">$</span><span class="va">overall_metrics</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check for problematic observations</span></span>
<span><span class="va">high_residuals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">validation</span><span class="op">$</span><span class="va">residuals</span><span class="op">$</span><span class="va">ilr1</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">high_residuals</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"Observations with large residuals:"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">validation</span><span class="op">$</span><span class="va">residuals</span><span class="op">[</span><span class="va">high_residuals</span>, <span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><strong>Error Metrics Interpretation:</strong> -
<strong>RMSE</strong>: Root mean squared error; smaller is better
(ideally &lt; 0.01 in ILR space) - <strong>MAE</strong>: Mean absolute
error; typical values 0.5-2% in composition space -
<strong>Mean_Error</strong>: Signed bias; should be close to zero -
<strong>Median_Error</strong>: Robustness to outliers</p>
<p>Non-zero residuals can indicate: - Numerical precision effects
(typically &lt; 1e-10 in ILR space) - Model convergence issues (switch
to univariate kriging if problematic) - Grid resolution effects
(predictions on coarse grids may miss exact locations)</p>
<p>For compositional back-transformation, residuals in ILR space can be
converted to composition space using <code>ilrInv()</code> for
interpretation in original units.</p>
</div>
<div class="section level3">
<h3 id="lmc-stability-and-admissibility">LMC Stability and Admissibility<a class="anchor" aria-label="anchor" href="#lmc-stability-and-admissibility"></a>
</h3>
<p>When using the LMC approach (<code>model_type = "lmc"</code>), the
positive-definiteness of the covariance structure is critical. The
<code><a href="../reference/gc_fit_vgm.html">gc_fit_vgm()</a></code> function now includes enhanced diagnostics via
the <code>correct.diagonal</code> parameter (default 1.01).</p>
<p>The <code>correct.diagonal</code> parameter multiplies each marginal
sill by a small factor to improve numerical stability:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Use enhanced variogram fitting with LMC diagnostics</span></span>
<span><span class="va">fitted_vgm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gc_fit_vgm.html">gc_fit_vgm</a></span><span class="op">(</span></span>
<span>  <span class="va">ilr_params</span>,</span>
<span>  data <span class="op">=</span> <span class="va">sample_locations_with_ilr</span>,</span>
<span>  aggregate <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  correct.diagonal <span class="op">=</span> <span class="fl">1.01</span>  <span class="co"># Default: slight diagonal inflation</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check LMC admissibility</span></span>
<span><span class="va">lmc_admissible</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">fitted_vgm</span>, <span class="st">"lmc_admissibility"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">lmc_admissible</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span><span class="st">"LMC sill matrix may not be positive-definite"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>If the model produces singular matrix errors during simulation,
increase <code>correct.diagonal</code> to 1.02-1.05, or switch to
univariate kriging (<code>model_type = "univariate"</code>, the default)
for better numerical stability.</p>
</div>
<div class="section level3">
<h3 id="comparing-univariate-vs-multivariate-modeling">Comparing Univariate vs Multivariate Modeling<a class="anchor" aria-label="anchor" href="#comparing-univariate-vs-multivariate-modeling"></a>
</h3>
<p>With conditional simulation now understood, we can compare the two
modeling approaches in practice. To see how univariate and LMC models
differ, we run conditional simulations with both and compare
results.</p>
<p>Create observation data:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">456</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create observation locations along a diagonal</span></span>
<span><span class="va">n_obs</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">t_vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="va">n_obs</span><span class="op">)</span></span>
<span><span class="va">obs_coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fl">10</span> <span class="op">+</span> <span class="fl">80</span> <span class="op">*</span> <span class="va">t_vals</span>,</span>
<span>  y <span class="op">=</span> <span class="fl">10</span> <span class="op">+</span> <span class="fl">80</span> <span class="op">*</span> <span class="va">t_vals</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Assign sandy loam compositions with measurement variation</span></span>
<span><span class="va">obs_comps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">obs_coords</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">base_comp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>SAND <span class="op">=</span> <span class="fl">55</span>, SILT <span class="op">=</span> <span class="fl">30</span>, CLAY <span class="op">=</span> <span class="fl">15</span><span class="op">)</span></span>
<span>  <span class="va">noise</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">3</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">obs_comp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">base_comp</span> <span class="op">+</span> <span class="va">noise</span>, <span class="fl">100</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="va">obs_comp</span> <span class="op">&lt;-</span> <span class="va">obs_comp</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">obs_comp</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span></span>
<span>  <span class="va">obs_comps</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">obs_comp</span></span>
<span><span class="op">}</span></span>
<span><span class="va">obs_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">obs_comps</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Transform to ILR space</span></span>
<span><span class="va">obs_ilr</span> <span class="op">&lt;-</span> <span class="fu">compositions</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/compositions/man/ilr.html" class="external-link">ilr</a></span><span class="op">(</span><span class="fu">compositions</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/compositions/man/acomp.html" class="external-link">acomp</a></span><span class="op">(</span><span class="va">obs_samples</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">obs_ilr</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ilr1"</span>, <span class="st">"ilr2"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">comparison_data</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">obs_coords</span><span class="op">$</span><span class="va">x</span>, y <span class="op">=</span> <span class="va">obs_coords</span><span class="op">$</span><span class="va">y</span>, <span class="va">obs_ilr</span><span class="op">)</span>,</span>
<span>  coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Build conditional models with both approaches:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Univariate model with conditioning data</span></span>
<span><span class="va">model_univ_cond</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gc_ilr_model.html">gc_ilr_model</a></span><span class="op">(</span></span>
<span>  <span class="va">params</span>, </span>
<span>  variogram_model <span class="op">=</span> <span class="va">vgm_model</span>,</span>
<span>  data <span class="op">=</span> <span class="va">comparison_data</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># LMC model with conditioning data</span></span>
<span><span class="va">model_lmc_cond</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gc_ilr_model.html">gc_ilr_model</a></span><span class="op">(</span></span>
<span>  <span class="va">params</span>, </span>
<span>  variogram_model <span class="op">=</span> <span class="va">vgm_model</span>,</span>
<span>  data <span class="op">=</span> <span class="va">comparison_data</span>,</span>
<span>  model_type <span class="op">=</span> <span class="st">"lmc"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Create a fine grid for simulation:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fine_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span>, by <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span>, by <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">fine_grid_sf</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">fine_grid</span>, coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Simulate with both models:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sims_univ_comp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gc_sim_composition.html">gc_sim_composition</a></span><span class="op">(</span></span>
<span>  <span class="va">model_univ_cond</span>, <span class="va">fine_grid_sf</span>, nsim <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  target_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sand"</span>, <span class="st">"silt"</span>, <span class="st">"clay"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">sims_lmc_comp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gc_sim_composition.html">gc_sim_composition</a></span><span class="op">(</span></span>
<span>  <span class="va">model_lmc_cond</span>, <span class="va">fine_grid_sf</span>, nsim <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  target_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sand"</span>, <span class="st">"silt"</span>, <span class="st">"clay"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Visual comparison:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sims_univ_comp</span><span class="op">[[</span><span class="st">"sand.sim1"</span><span class="op">]</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">"Univariate: Sand"</span>, zlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">75</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cond_coords</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">comparison_data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/lines.html" class="external-link">points</a></span><span class="op">(</span><span class="va">cond_coords</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, <span class="va">cond_coords</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, pch <span class="op">=</span> <span class="fl">1</span>, cex <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">"black"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sims_lmc_comp</span><span class="op">[[</span><span class="st">"sand.sim1"</span><span class="op">]</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">"LMC: Sand"</span>, zlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">75</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/lines.html" class="external-link">points</a></span><span class="op">(</span><span class="va">cond_coords</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, <span class="va">cond_coords</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, pch <span class="op">=</span> <span class="fl">1</span>, cex <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">"black"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="soil_texture_workflow_files/figure-html/unnamed-chunk-39-1.png" class="r-plt" alt="" width="800" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Numerical comparison at observation locations:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract predicted values at observation points</span></span>
<span><span class="va">univ_extracted</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">sims_univ_comp</span>, <span class="va">comparison_data</span><span class="op">)</span></span>
<span><span class="va">lmc_extracted</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">sims_lmc_comp</span>, <span class="va">comparison_data</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare to observed values</span></span>
<span><span class="va">comparison_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  Observed <span class="op">=</span> <span class="va">obs_samples</span><span class="op">$</span><span class="va">SAND</span>,</span>
<span>  Univariate <span class="op">=</span> <span class="va">univ_extracted</span><span class="op">$</span><span class="va">sand.sim1</span>,</span>
<span>  LMC <span class="op">=</span> <span class="va">lmc_extracted</span><span class="op">$</span><span class="va">sand.sim1</span>,</span>
<span>  Univ_Error <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">univ_extracted</span><span class="op">$</span><span class="va">sand.sim1</span> <span class="op">-</span> <span class="va">obs_samples</span><span class="op">$</span><span class="va">SAND</span><span class="op">)</span>,</span>
<span>  LMC_Error <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">lmc_extracted</span><span class="op">$</span><span class="va">sand.sim1</span> <span class="op">-</span> <span class="va">obs_samples</span><span class="op">$</span><span class="va">SAND</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">comparison_table</span></span>
<span><span class="co">#&gt;    Observed Univariate      LMC   Univ_Error    LMC_Error</span></span>
<span><span class="co">#&gt; 1  52.23030   52.23030 52.23030 1.421085e-14 0.000000e+00</span></span>
<span><span class="co">#&gt; 2  54.88676   50.69617 61.24788 4.190586e+00 6.361118e+00</span></span>
<span><span class="co">#&gt; 3  54.26647   55.14599 53.15188 8.795135e-01 1.114598e+00</span></span>
<span><span class="co">#&gt; 4  55.07955   57.19096 56.84773 2.111406e+00 1.768171e+00</span></span>
<span><span class="co">#&gt; 5  55.64003   44.72407 59.25459 1.091597e+01 3.614557e+00</span></span>
<span><span class="co">#&gt; 6  54.45975   52.54057 57.05396 1.919183e+00 2.594207e+00</span></span>
<span><span class="co">#&gt; 7  55.82712   54.71037 46.46575 1.116746e+00 9.361366e+00</span></span>
<span><span class="co">#&gt; 8  54.78208   58.29805 58.46982 3.515965e+00 3.687736e+00</span></span>
<span><span class="co">#&gt; 9  54.23885   50.77341 53.17414 3.465442e+00 1.064710e+00</span></span>
<span><span class="co">#&gt; 10 54.27075   54.27075 54.27075 0.000000e+00 7.105427e-15</span></span></code></pre></div>
<p>Both approaches produce similar results at observation locations. The
univariate model achieves a mean absolute error of ~2.8% and maximum
error of ~10.9%, while the LMC model shows mean absolute error of ~3.0%
and maximum error of ~9.4%. These differences are negligible for
practical purposes, confirming that the simpler univariate approach is
adequate. The univariate method is preferred for its numerical
stability, computational efficiency, and ease of interpretation.</p>
</div>
</div>
<div class="section level2">
<h2 id="quality-assessment-and-remediation">Quality Assessment and Remediation<a class="anchor" aria-label="anchor" href="#quality-assessment-and-remediation"></a>
</h2>
<div class="section level3">
<h3 id="evaluating-data-quality-stationarity-and-gaussianity">Evaluating Data Quality: Stationarity and Gaussianity<a class="anchor" aria-label="anchor" href="#evaluating-data-quality-stationarity-and-gaussianity"></a>
</h3>
<p>Before proceeding to spatial simulation, assess whether the data
meets the assumptions required by geostatistical methods. Two key
assessments inform the remediation strategy:</p>
<ul>
<li>
<strong>Stationarity</strong>: Whether the statistical properties
vary across the study area</li>
<li>
<strong>Gaussianity</strong>: Whether the ILR-transformed data are
multivariate normal</li>
</ul>
<p>Based on the results of these assessments, you can select appropriate
remediation techniques.</p>
<p>Prepare sample data with ILR values for diagnostics:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create sample data with spatial coordinates</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">n_samples</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">sample_locations_with_ilr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n_samples</span>, <span class="fl">0</span>, <span class="fl">100</span><span class="op">)</span>,</span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n_samples</span>, <span class="fl">0</span>, <span class="fl">100</span><span class="op">)</span>,</span>
<span>  ilr1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_samples</span>, mean <span class="op">=</span> <span class="fl">0.5</span>, sd <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span>,</span>
<span>  ilr2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_samples</span>, mean <span class="op">=</span> <span class="op">-</span><span class="fl">0.2</span>, sd <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">sample_locations_with_ilr</span><span class="op">)</span></span>
<span><span class="co">#&gt;          x        y        ilr1       ilr2</span></span>
<span><span class="co">#&gt; 1 28.75775 59.99890 -0.06832525  1.1192862</span></span>
<span><span class="co">#&gt; 2 78.83051 33.28235  0.70550697  0.5874478</span></span>
<span><span class="co">#&gt; 3 40.89769 48.86130  0.30264650 -0.3590870</span></span>
<span><span class="co">#&gt; 4 88.30174 95.44738  0.22196592  0.1259164</span></span>
<span><span class="co">#&gt; 5 94.04673 48.29024 -0.26129485 -0.4486040</span></span>
<span><span class="co">#&gt; 6  4.55565 89.03502  0.46397782 -0.4857481</span></span></code></pre></div>
<div class="section level4">
<h4 id="assessing-stationarity">Assessing Stationarity<a class="anchor" aria-label="anchor" href="#assessing-stationarity"></a>
</h4>
<p>Spatial stationarity means the covariance structure is constant
across the domain. Non-stationarity suggests the domain contains
distinct compositional provinces that should be modeled separately.</p>
<p>The <code>gc_assess_stationarity()</code> function uses PCA biplot
visualization to detect spatial clustering of data points:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stationarity_result</span> <span class="op">&lt;-</span> <span class="fu">gc_assess_stationarity</span><span class="op">(</span></span>
<span>  <span class="va">sample_locations_with_ilr</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"biplot"</span>,</span>
<span>  plot <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="soil_texture_workflow_files/figure-html/unnamed-chunk-42-1.png" class="r-plt" alt="" width="800"></p>
<p>The biplot colors points by X-coordinate. If points cluster by
spatial location (e.g., left side vs right side in the same direction),
this indicates non-stationarity and suggests domain stratification.</p>
<p><strong>Interpretation:</strong></p>
<ul>
<li>
<strong>Stationary</strong>: Points scattered randomly in the biplot
without spatial clustering. Proceed with global LMC modeling.</li>
<li>
<strong>Non-stationary</strong>: Points cluster spatially. Either
stratify the domain or apply domain-specific models for each
stratum.</li>
</ul>
<p>An alternative quantitative approach divides the domain into
windows:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stationarity_local</span> <span class="op">&lt;-</span> <span class="fu">gc_assess_stationarity</span><span class="op">(</span></span>
<span>  <span class="va">sample_locations_with_ilr</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"local"</span>,</span>
<span>  plot <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">stationarity_local</span><span class="op">$</span><span class="va">summary</span></span>
<span><span class="co">#&gt;          Method WindowsAnalyzed NormalizedCovDiff Stationary</span></span>
<span><span class="co">#&gt; 1 Local Windows              12            0.6876      FALSE</span></span>
<span><span class="co">#&gt;                                                                                                          Interpretation</span></span>
<span><span class="co">#&gt; 1 Potential non-stationarity detected: Local covariances vary substantially (0.688). Domain stratification recommended.</span></span></code></pre></div>
<p>The local method compares covariance structures within windows. Large
variation between windows indicates non-stationarity and supports domain
stratification.</p>
</div>
<div class="section level4">
<h4 id="assessing-gaussianity">Assessing Gaussianity<a class="anchor" aria-label="anchor" href="#assessing-gaussianity"></a>
</h4>
<p>Sequential Gaussian Simulation assumes the ILR-transformed data are
multivariate normal. The <code>gc_assess_gaussianity()</code> function
tests this assumption:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ilr_values</span> <span class="op">&lt;-</span> <span class="va">sample_locations_with_ilr</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ilr1"</span>, <span class="st">"ilr2"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">gaussianity_result</span> <span class="op">&lt;-</span> <span class="fu">gc_assess_gaussianity</span><span class="op">(</span></span>
<span>  <span class="va">ilr_values</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"anderson"</span>,</span>
<span>  plot <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  alpha <span class="op">=</span> <span class="fl">0.05</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="soil_texture_workflow_files/figure-html/unnamed-chunk-44-1.png" class="r-plt" alt="" width="800"></p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">gaussianity_result</span><span class="op">$</span><span class="va">recommendation</span></span>
<span><span class="co">#&gt; [1] "Non-Gaussianity detected in dimension(s) 2. Recommend anamorphosis (normal-score transform) or domain stratification."</span></span></code></pre></div>
<p><strong>Available Methods:</strong></p>
<ul>
<li>
<strong>Anderson-Darling</strong> (recommended): Tests each ILR
dimension separately. Sensitive to tail departures from normality.</li>
<li>
<strong>Shapiro-Wilk</strong>: Alternative univariate test, limited
to N ≤ 5000 samples.</li>
<li>
<strong>Mardia</strong>: Multivariate test for joint skewness and
kurtosis, provides holistic assessment.</li>
</ul>
<p><strong>Interpretation:</strong></p>
<ul>
<li>
<strong>Gaussian</strong> (p-value &gt; 0.05): Proceed with
Sequential Gaussian Simulation (SGS).</li>
<li>
<strong>Non-Gaussian</strong> (p-value ≤ 0.05): Consider
remediation:
<ul>
<li>Apply anamorphosis (normal-score back-transform after
simulation)</li>
<li>Stratify domain by geological or soil units</li>
<li>Document and accept uncertainty in the simulation</li>
</ul>
</li>
</ul>
</div>
<div class="section level4">
<h4 id="applying-anamorphosis-remediation">Applying Anamorphosis Remediation<a class="anchor" aria-label="anchor" href="#applying-anamorphosis-remediation"></a>
</h4>
<p>When data are non-Gaussian, anamorphosis transforms simulated values
from normal space back to the original data distribution while
preserving spatial correlation. This works by matching quantiles of the
simulated data to quantiles of the reference data.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ilr_values</span> <span class="op">&lt;-</span> <span class="va">sample_locations_with_ilr</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ilr1"</span>, <span class="st">"ilr2"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">sim_ilr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">50</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">sim_ilr</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ilr1"</span>, <span class="st">"ilr2"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">back_transformed</span> <span class="op">&lt;-</span> <span class="fu">gc_apply_anamorphosis</span><span class="op">(</span></span>
<span>  <span class="va">sim_ilr</span>,</span>
<span>  ref_ilr_values <span class="op">=</span> <span class="va">ilr_values</span>,</span>
<span>  despike <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">ref_range</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">ilr_values</span>, <span class="fl">2</span>, <span class="va">range</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">back_transformed</span> <span class="op">&gt;=</span> <span class="va">ref_range</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span> <span class="op">&amp;</span> <span class="va">back_transformed</span> <span class="op">&lt;=</span> <span class="va">ref_range</span><span class="op">[</span><span class="fl">2</span>, <span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
<p>The anamorphosis process:</p>
<ol style="list-style-type: decimal">
<li>Computes quantiles of the reference (original) ILR values</li>
<li>Computes quantiles of the simulated values</li>
<li>Maps simulated quantiles to reference quantiles (inverse
transform)</li>
<li>Interpolates for values between quantiles</li>
<li>Optionally despiking to cap extreme extrapolations</li>
</ol>
<p>This preserves the marginal distribution of the original data while
maintaining spatial correlation structure from the simulation.</p>
</div>
<div class="section level4">
<h4 id="identifying-domain-strata">Identifying Domain Strata<a class="anchor" aria-label="anchor" href="#identifying-domain-strata"></a>
</h4>
<p>When non-stationarity is detected, the domain may contain distinct
compositional provinces or geological units that should be modeled
separately. The <code>gc_identify_strata()</code> function partitions
observations into spatially-coherent strata using clustering
methods.</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Identify strata using K-means clustering in PCA space</span></span>
<span><span class="va">strata_result</span> <span class="op">&lt;-</span> <span class="fu">gc_identify_strata</span><span class="op">(</span></span>
<span>  <span class="va">sample_locations_with_ilr</span>,</span>
<span>  n_strata <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"kmeans"</span>,</span>
<span>  plot <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="soil_texture_workflow_files/figure-html/unnamed-chunk-46-1.png" class="r-plt" alt="" width="800"></p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Examine the stratification results</span></span>
<span><span class="va">strata_result</span><span class="op">$</span><span class="va">n_strata</span></span>
<span><span class="co">#&gt; [1] 2</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">strata_result</span><span class="op">$</span><span class="va">strata</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  1  2 </span></span>
<span><span class="co">#&gt; 65 35</span></span></code></pre></div>
<p>The stratification identifies:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Strata in PCA space</strong>: Shows how clusters separate
observations based on compositional variance. PCA reduces dimensionality
while retaining the structure that distinguishes domains.</p></li>
<li><p><strong>Strata in spatial layout</strong>: Reveals whether
clusters are geographically coherent. Tight, localized clusters indicate
true domain partitioning, while scattered patterns may suggest mixed
lithologies or contamination.</p></li>
<li><p><strong>Quality metrics</strong>: Silhouette widths measure how
well each observation fits its assigned stratum (ranges from -1 to 1,
where &gt;0.5 indicates good separation). Average silhouette widths by
stratum guide model selection.</p></li>
</ol>
<p>Once strata are identified, you can model each stratum
independently:</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Model first stratum</span></span>
<span><span class="va">stratum_1_data</span> <span class="op">&lt;-</span> <span class="va">sample_locations_with_ilr</span><span class="op">[</span><span class="va">strata_result</span><span class="op">$</span><span class="va">strata</span> <span class="op">==</span> <span class="fl">1</span>, <span class="op">]</span></span>
<span><span class="va">stratum_2_data</span> <span class="op">&lt;-</span> <span class="va">sample_locations_with_ilr</span><span class="op">[</span><span class="va">strata_result</span><span class="op">$</span><span class="va">strata</span> <span class="op">==</span> <span class="fl">2</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co"># Each stratum can now be assessed for stationarity and Gaussianity</span></span>
<span><span class="va">stat_1</span> <span class="op">&lt;-</span> <span class="fu">gc_assess_stationarity</span><span class="op">(</span><span class="va">stratum_1_data</span>, method <span class="op">=</span> <span class="st">"biplot"</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">stat_2</span> <span class="op">&lt;-</span> <span class="fu">gc_assess_stationarity</span><span class="op">(</span><span class="va">stratum_2_data</span>, method <span class="op">=</span> <span class="st">"biplot"</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Proceed with workflow on each stratum independently</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="integrated-diagnostic-workflow">Integrated Diagnostic Workflow<a class="anchor" aria-label="anchor" href="#integrated-diagnostic-workflow"></a>
</h4>
<p>A complete assessment combines stationarity and Gaussianity tests to
determine the appropriate remediation strategy. Run both diagnostics on
your data:</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stat_result</span> <span class="op">&lt;-</span> <span class="fu">gc_assess_stationarity</span><span class="op">(</span></span>
<span>  <span class="va">sample_locations_with_ilr</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"biplot"</span>,</span>
<span>  plot <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">ilr_vals</span> <span class="op">&lt;-</span> <span class="va">sample_locations_with_ilr</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ilr1"</span>, <span class="st">"ilr2"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">gauss_result</span> <span class="op">&lt;-</span> <span class="fu">gc_assess_gaussianity</span><span class="op">(</span></span>
<span>  <span class="va">ilr_vals</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"anderson"</span>,</span>
<span>  plot <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">assessment</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  Aspect <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Stationarity"</span>, <span class="st">"Gaussianity"</span><span class="op">)</span>,</span>
<span>  Status <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">stat_result</span><span class="op">$</span><span class="va">stationary</span><span class="op">)</span> <span class="st">"Yes"</span> <span class="kw">else</span> <span class="st">"No"</span>,</span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">gauss_result</span><span class="op">$</span><span class="va">gaussian</span><span class="op">)</span> <span class="st">"Yes"</span> <span class="kw">else</span> <span class="st">"No"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">assessment</span></span>
<span><span class="co">#&gt;         Aspect Status</span></span>
<span><span class="co">#&gt; 1 Stationarity    Yes</span></span>
<span><span class="co">#&gt; 2  Gaussianity     No</span></span></code></pre></div>
<p>The results determine your remediation path:</p>
<ul>
<li>
<strong>Stationary + Gaussian</strong>: Proceed with standard
workflow (LMC modeling with Sequential Gaussian Simulation)</li>
<li>
<strong>Non-stationary + Gaussian</strong>: Stratify domain using
<code>gc_identify_strata()</code>, apply workflow to each stratum</li>
<li>
<strong>Stationary + Non-Gaussian</strong>: Apply anamorphosis to
simulated results with <code>gc_apply_anamorphosis()</code>
</li>
<li>
<strong>Non-stationary + Non-Gaussian</strong>: Stratify domain AND
apply anamorphosis to each stratum’s simulated results</li>
</ul>
<p>The <code>gc_identify_strata()</code> function can automatically
partition the domain based on PCA clustering if non-stationarity is
detected, suggesting where to split the data for independent
modeling.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<ul>
<li>Aitchison, J. (1986). The Statistical Analysis of Compositional
Data.</li>
<li>Egozcue et al. (2003). Isometric logratio transformations for
compositional data analysis.</li>
<li>Chilès, J.P. &amp; Delfiner, P. (2012). Geostatistics: Modeling
Spatial Uncertainty.</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Andrew Brown.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
