% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/ensemble_validation.R
\name{gc_aggregate_realizations}
\alias{gc_aggregate_realizations}
\title{Aggregate Multiple Realizations to Summary Statistics}
\usage{
gc_aggregate_realizations(
  realizations,
  components,
  realizations_per_component = NULL,
  stats = c("mean", "sd", "p05", "p95"),
  verbose = FALSE
)
}
\arguments{
\item{realizations}{A list of \code{terra::SpatRaster} objects (output from
multiple calls to \code{gc_sim_composition()} with \code{nsim=1} each), OR a
single \code{terra::SpatRaster} with multiple layers organized as:
\verb{[comp1.sim1, comp1.sim2, ..., comp1.simN, comp2.sim1, ...]}}

\item{components}{Character vector, names of compositional components
(e.g., c("sand", "silt", "clay"))}

\item{realizations_per_component}{Integer, number of realizations per component.
If NULL (default), inferred from raster layer names (e.g., "sand.sim1" → 1)}

\item{stats}{Character vector, summary statistics to compute:
\itemize{
\item "mean": arithmetic mean
\item "median": median (50th percentile)
\item "sd": standard deviation
\item "cv": coefficient of variation (sd/mean, useful for normalized uncertainty)
\item "p05", "p25", "p75", "p95": quantiles
\item "ci_lower", "ci_upper": 95\% confidence intervals (2.5th, 97.5th percentiles)
}}

\item{verbose}{Logical, report processing steps (default FALSE)}
}
\value{
A \code{terra::SpatRaster} with layers for each component × statistic.
Layer names follow pattern: \code{component_stat} (e.g., "sand_mean", "silt_sd")
}
\description{
Combine multiple stochastic simulation realizations into ensemble summary
maps (mean, median, standard deviation, quantiles, confidence intervals).
Useful for communicating uncertainty and central tendency.
}
\details{
This function assumes realizations are stored in a consistent format:
either as a list where each element is a single-component raster,
or as a multi-layer raster where layers are grouped by component then by realization.

Common workflow:

\if{html}{\out{<div class="sourceCode r">}}\preformatted{# Generate N realizations separately
real_1 <- gc_sim_composition(model, domain, nsim = 1)
real_2 <- gc_sim_composition(model, domain, nsim = 1)
real_N <- gc_sim_composition(model, domain, nsim = 1)

# Combine stack and aggregate
all_reals <- c(real_1, real_2, ..., real_N)
ensemble_stats <- gc_aggregate_realizations(
  all_reals,
  components = c("sand", "silt", "clay"),
  stats = c("mean", "sd", "p05", "p95")
)
}\if{html}{\out{</div>}}
}
\examples{
# Hypothetical ensemble of 3 realizations × 3 components
# (In practice, generate via gc_sim_composition(..., nsim=1) repeated)

# Create synthetic raster stack
r <- terra::rast(nrows = 10, ncols = 10, nlyrs = 9)
terra::ext(r) <- c(0, 100, 0, 100)
terra::crs(r) <- "EPSG:4326"

# Set layer names: sand.sim1, sand.sim2, sand.sim3, ..., clay.sim3
nlyr_per_comp <- 3
comps <- c("sand", "silt", "clay")
names(r) <- paste0(
  rep(comps, each = nlyr_per_comp),
  ".sim",
  rep(1:nlyr_per_comp, times = length(comps))
)

# Fill with random compositions summing to 100
set.seed(42)
for (i in 1:terra::nlyr(r)) {
  vals <- abs(stats::rnorm(terra::ncell(r), 50, 10))
  vals <- vals / rowSums(matrix(vals, ncol = 3, byrow = FALSE)) * 100
  terra::values(r)[, i] <- vals[, i]
}

# Aggregate to ensemble statistics
ensemble <- gc_aggregate_realizations(
  r,
  components = comps,
  stats = c("mean", "sd", "p05", "p95")
)

# Inspect output
terra::names(ensemble)  # e.g., "sand_mean", "sand_sd", "sand_p05", ...

}
