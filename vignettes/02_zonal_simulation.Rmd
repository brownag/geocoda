---
title: "Zonal Geostatistical Simulation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Zonal Geostatistical Simulation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5
)
```

## Overview

Fit variograms from observed soil composition data, then generate spatially-correlated realizations that satisfy compositional constraints.

---

## Workflow

### 1. Prepare Data

```{r step1}
library(geocoda)
library(terra)
library(sf)
library(gstat)

observed_data <- data.frame(
  x = c(10, 30, 50, 70, 90),
  y = c(20, 40, 60, 80, 85),
  SAND = c(55, 48, 35, 42, 60),
  SILT = c(30, 38, 45, 40, 25),
  CLAY = c(15, 14, 20, 18, 15)
)

observed_data$total <- rowSums(observed_data[, c("SAND", "SILT", "CLAY")])
observed_data$total
```

**Key insight:** ILR transforms are automatic; you just pass raw compositions.

### 2. Fit Variogram

```{r step2}
ilr_params <- gc_ilr_params(observed_data[, c("SAND", "SILT", "CLAY")])

obs_sf <- st_as_sf(
  observed_data[, c("x", "y", "SAND", "SILT", "CLAY")],
  coords = c("x", "y"), crs = NA
)

obs_ilr <- compositions::ilr(compositions::acomp(
  observed_data[, c("SAND", "SILT", "CLAY")]
))
colnames(obs_ilr) <- c("ilr1", "ilr2")

vgm_data <- data.frame(
  x = observed_data$x,
  y = observed_data$y,
  ilr1 = obs_ilr[, 1],
  ilr2 = obs_ilr[, 2]
)

vgm_fitted <- gc_fit_vgm(
  ilr_params,
  data = vgm_data,
  aggregate = TRUE
)
vgm_fitted
```

### 3. Build Model

```{r step3}
model_fitted <- gc_ilr_model(
  ilr_params = ilr_params,
  variogram_model = vgm_fitted
)
```

### 4. Create Prediction Grid

```{r step4}
pred_grid <- expand.grid(
  x = seq(0, 100, by = 10),
  y = seq(0, 100, by = 10)
)
pred_grid_sf <- st_as_sf(pred_grid, coords = c("x", "y"), crs = NA)
```

### 5. Generate Realizations

Unconditional simulation:

```{r sim_uncond}
# Generate independent realizations
# (each realization is a different plausible spatial map)
sims_uncond <- gc_sim_composition(
  model = model_fitted,
  locations = pred_grid_sf,
  nsim = 3,
  target_names = c("SAND", "SILT", "CLAY"),
)

cat("Realization layers:\n")
print(names(sims_uncond))

# Summary of first realization
cat("\nFirst realization (sim 1) - sand % statistics:\n")
sand_sim1 <- sims_uncond$SAND.sim1
cat("  Min:", min(values(sand_sim1), na.rm = TRUE), "%\n")
cat("  Max:", max(values(sand_sim1), na.rm = TRUE), "%\n")
cat("  Mean:", mean(values(sand_sim1), na.rm = TRUE), "%\n")
```

### Conditional Simulation

Condition simulations on observed data (realizations pass exactly through sample points):

```{r sim_cond}
obs_sf$ilr1 <- obs_ilr[, 1]
obs_sf$ilr2 <- obs_ilr[, 2]

model_cond <- gc_ilr_model(
  ilr_params = ilr_params,
  variogram_model = vgm_fitted,
  data = obs_sf
)

sims_cond <- gc_sim_composition(
  model = model_cond,
  locations = pred_grid_sf,
  nsim = 3,
  target_names = c("SAND", "SILT", "CLAY")
)

names(sims_cond)
```

---

## Visualization

```{r viz}
plot(sims_cond[[1:3]], zlim = c(0, 100))
```

---

## Validation

Verify constraint satisfaction:

```{r validation}
for (i in seq(3)) {
  sand_col <- paste0("SAND.sim", i)
  silt_col <- paste0("SILT.sim", i)
  clay_col <- paste0("CLAY.sim", i)

  total <- sims_cond[[sand_col]] +
           sims_cond[[silt_col]] +
           sims_cond[[clay_col]]

  range(values(total), na.rm = TRUE)
}
```

---

## Key points

[OK] ILR transforms handle compositional constraints automatically
[OK] Variogram fitting from observed data more reliable than defaults
[OK] Conditional simulation honors observed data exactly
[OK] Multiple realizations represent spatial uncertainty

---

## References

- `?gc_ilr_params()` -- Estimate ILR parameters
- `?gc_fit_vgm()` -- Variogram fitting
- `?gc_ilr_model()` -- Build kriging model
- `?gc_sim_composition()` -- Generate realizations
