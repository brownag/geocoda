---
title: "Advanced: 3D Soil Profile Mapping"
author: "Andrew G. Brown"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    number_sections: true
vignette: >
  %\VignetteIndexEntry{Advanced 3D Mapping}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 8,
  fig.height = 6,
  dpi = 100
)
```

# Overview

This vignette demonstrates 3D soil profile mapping that extends beyond 2D surface models to include depth-dependent variation. Topics covered:

1. **Depth stratification** - Standardizing irregular horizon depths
2. **Horizon-based stratification** - Modeling distinct soil layers
3. **Multivariate decorrelation** - Minimum/Maximum Autocorrelation Factors (MAF)
4. **Stratigraphic coordinates** - Unwrinkling complex geometries (see vignette 10_3d_stratigraphic_geostatistics)
5. **3D visualization** - Representing soil spatial uncertainty

See **Vignette 10: 3D Stratigraphic Geostatistics** for complete 3D implementation including variogram fitting, simulation, and block averaging.

# Setup

```{r, message=FALSE}
library(geocoda)
library(terra)
library(sf)

set.seed(42)
```

# Depth Stratification Basics

## Model Each Depth Interval Separately

Real-world soil survey data typically comes from multiple depths. Rather than treating depth as a covariate, we can model each depth interval independently:

```{r depth_data}
# Multi-depth soil observations
soil_profiles <- data.frame(
  profile_id = c(1, 1, 1, 2, 2, 2, 3, 3, 3),
  depth_label = rep(c("A", "B", "C"), 3),
  depth_cm = rep(c(10, 45, 90), 3),
  x = rep(c(10, 30, 50), each = 3),
  y = rep(c(20, 40, 60), each = 3),
  SAND = c(60, 45, 35, 58, 42, 32, 62, 48, 38),
  SILT = c(25, 35, 40, 27, 38, 42, 23, 34, 38),
  CLAY = c(15, 20, 25, 15, 20, 26, 15, 18, 24)
)

# Verify compositional constraint
soil_profiles$total <- rowSums(soil_profiles[, c("SAND", "SILT", "CLAY")])
all(abs(soil_profiles$total - 100) < 0.01)

# Examine depth trends
depth_summary <- data.frame()
for (depth in unique(soil_profiles$depth_label)) {
  subset_data <- soil_profiles[soil_profiles$depth_label == depth, ]
  depth_summary <- rbind(depth_summary, data.frame(
    Horizon = depth,
    Mean_Sand = round(mean(subset_data$SAND), 1),
    Mean_Clay = round(mean(subset_data$CLAY), 1)
  ))
}

depth_summary
```

## Horizon-Specific Modeling

Each horizon has distinct compositional properties and covariance structure. By modeling horizons separately, we capture these differences.

```{r horizon_modeling}
ilr_summary <- data.frame()
for (horizon in c("A", "B", "C")) {
  horizon_data <- soil_profiles[soil_profiles$depth_label == horizon,
                                c("SAND", "SILT", "CLAY")]

  ilr_params <- gc_ilr_params(horizon_data)

  ilr_summary <- rbind(ilr_summary, data.frame(
    Horizon = horizon,
    ILR1_Mean = round(ilr_params$mean[1], 3),
    ILR2_Mean = round(ilr_params$mean[2], 3),
    ILR1_Var = round(diag(ilr_params$cov)[1], 3),
    ILR2_Var = round(diag(ilr_params$cov)[2], 3)
  ))
}

ilr_summary
```

# Depth-Stratified Workflow

## Step-by-Step Approach

```{r depth_workflow}
horizons <- list(
  A = soil_profiles[soil_profiles$depth_label == "A", ],
  B = soil_profiles[soil_profiles$depth_label == "B", ],
  C = soil_profiles[soil_profiles$depth_label == "C", ]
)

horizon_ilr <- list()
for (h_name in names(horizons)) {
  horizon_ilr[[h_name]] <- gc_ilr_params(
    horizons[[h_name]][, c("SAND", "SILT", "CLAY")]
  )
}

# Summary of workflow steps
workflow_steps <- data.frame(
  Step = 1:5,
  Action = c(
    "Separate data by depth",
    "Compute ILR parameters per horizon",
    "Fit per-horizon variograms",
    "Generate realizations per horizon",
    "Combine for 3D output"
  ),
  Output = c(
    "3 horizon lists",
    "3 ILR parameter sets",
    "3 variogram models",
    "3 simulation results",
    "3D volume"
  )
)

workflow_steps
```

## Creating Standardized Depth Slices

Future integration with `aqp` package will enable mass-preserving spline standardization to GlobalSoilMap depths (0-5, 5-15, 15-30, etc.):

```{r standardized_depths_placeholder, eval=FALSE}
# Example: Depth standardization using aqp integration

# Standardize to GlobalSoilMap depths
standardized <- gc_standardize_depths(
  profiles = soil_profiles,
  method = "spline",  # Mass-preserving
  intervals = c(5, 15, 30, 60, 100)  # cm depths
)

# Result: Standardized compositions at fixed depths
# Enables comparison across surveys with different depth schemes
```

# Multivariate Decorrelation (Advanced)

## Minimum/Maximum Autocorrelation Factors (MAF)

**MAF decorrelation** improves multivariate simulation by separating spatial signal from noise. See **Vignette 05_ensemble** for MAF implementation. MAF separates spatial signal from noise:

```{r maf_concept, eval=FALSE}
# Example: MAF decorrelation for multivariate simulation

# Two approaches:

# Option 1: MAF on ILR coordinates (spatial decorrelation)
# Apply MAF to ILR space, simulate MAF factors independently, back-rotate
maf_ilr <- gc_maf_transform(
  ilr_coords,
  coords = coordinates,
  lag_h = 50,  # Lag for spatial covariance
  method = "spatial"
)

# Option 2: MAF on non-compositional properties
# Decorrelate pH, CEC, OM, etc. for joint simulation
maf_props <- gc_maf_transform(
  multivariate_data,
  coords = coordinates,
  method = "compositional"
)

# Simulate MAF factors independently
# Result: Improved correlation structure reproduction
```

**Use when**: Multiple correlated properties, want to reduce redundancy in simulation.

# 3D Stratigraphic Coordinates (Advanced 3D Modeling)

## True 3D Geostatistics

**Stratigraphic coordinate transformation** enables complex geometry handling. See **Vignette 10: 3D Stratigraphic Geostatistics** for complete implementation including variogram fitting, 3D simulation, and block averaging:

```{r stratigraphic_placeholder, eval=FALSE}
# Example: Stratigraphic coordinate transformation for 3D modeling
# See Vignette 10_3d_stratigraphic_geostatistics for complete implementation

# Define horizon surfaces (top and bottom of soil layer)
top_surface <- dem_raster  # Interpolated horizon top
bottom_surface <- bedrock_raster  # Bedrock surface

# Transform to stratigraphic coordinates
# z_strat = (z - z_base) / (z_top - z_base) × h_constant
data_strat <- gc_stratigraphic_transform(
  data = soil_profiles,
  surfaces = list(top = top_surface, bottom = bottom_surface),
  transform_type = "proportional"
)

# 3D kriging/simulation in stratigraphic space
# Preserves parallel-to-surface pedogenic processes
# Handles sloping landscapes, complex geometries

# Back-transform to Cartesian coordinates (x, y, z)
predictions_xyz <- gc_inverse_stratigraphic_transform(
  data_strat,
  surfaces = list(top = top_surface, bottom = bottom_surface)
)
```

**Use when**: Complex topography, sloping horizons, eroded profiles requiring true 3D representation.

# Current Capabilities & Roadmap

## What Works Now (2D + Depth Covariate)

✓ Separate modeling per horizon/depth
✓ Hierarchical zone models with depth stratification
✓ Depth as external predictor (covariate approach)
✓ 2D simulation for each depth independently

## Available Features

✓ **MAF decorrelation** - Separate spatial signal from noise (see Vignette 05_ensemble)
✓ **Direct block simulation** - Management-unit scale uncertainty
✓ Integration with aqp for spline-based standardization

✓ **Stratigraphic coordinates** - True 3D unwrinkling (see Vignette 10_3d_stratigraphic_geostatistics)
✓ **3D variogram modeling** with anisotropy
✓ **Complex landscape 3D simulation** with full implementation

# Practical Example: CurrentCapabilities

## Complete Depth-Stratified Workflow

```{r depth_workflow_example, eval=FALSE}
# 1. Prepare A and C horizons separately
surface_data <- soil_data[soil_data$depth < 30, ]
subsurface_data <- soil_data[soil_data$depth > 60, ]

# 2. ILR transform each
surf_ilr <- gc_ilr_params(surface_data[, c("SAND", "SILT", "CLAY")])
sub_ilr <- gc_ilr_params(subsurface_data[, c("SAND", "SILT", "CLAY")])

# 3. Fit variograms per horizon
vgm_surface <- gc_fit_vgm(surf_ilr, data = surface_data_ilr)
vgm_subsurface <- gc_fit_vgm(sub_ilr, data = subsurface_data_ilr)

# 4. Build models
model_surface <- gc_ilr_model(surf_ilr, vgm_surface)
model_subsurface <- gc_ilr_model(sub_ilr, vgm_subsurface)

# 5. Simulate independently
sims_surface <- gc_sim_composition(
  model_surface, grid_sf, nsim = 10,
  target_names = c("SAND", "SILT", "CLAY")
)

sims_subsurface <- gc_sim_composition(
  model_subsurface, grid_sf, nsim = 10,
  target_names = c("SAND", "SILT", "CLAY")
)

# 6. Create output: 2D + depth dimension
# Combine for complete 3D representation (surface + subsurface maps)
```

# Best Practices for Depth Stratification

1. **Define depth breaks clearly** - A (0-30cm), B (30-60cm), C (60+ cm)
2. **Model independently** - Don't assume covariance between depths
3. **Validate per horizon** - Check constraints separately
4. **Document assumptions** - Are boundaries fixed or variable?
5. **Consider 3D capabilities** - Use stratigraphic coordinates and 3D simulation (see Vignette 10) for true 3D handling

# Integration Points

- **Vignette 00**: Include depth considerations in workflow
- **Vignette 01**: Depth-stratified data preparation
- **Vignette 03**: Hierarchical models with depth + zone structure
- **Vignette 05**: MAF decorrelation implementation
- **Vignette 09**: Feature roadmap and development status
- **Vignette 10**: Complete 3D stratigraphic geostatistics workflow

# Related Vignettes

For capabilities now available:

```{r available_capabilities}
capabilities <- data.frame(
  Status = c("✓ Available", "✓ Available", "✓ Available"),
  Feature = c(
    "2D + depth stratification",
    "MAF decorrelation",
    "Stratigraphic coordinates + 3D"
  ),
  Vignette = c(
    "This vignette (04)",
    "Vignette 05_ensemble",
    "Vignette 10_3d_stratigraphic_geostatistics"
  )
)

print(capabilities)
```

# References

- Bishop, T. F., McBratney, A. B., & Laslett, G. M. (1999). Modelling soil attribute depth functions with equal-area quadratic smoothing splines. *Geoderma*, 91(1-2), 27-45.
- Malone, B. P., McBratney, A. B., & Minasny, B. (2017). Empirical estimates of uncertainty for mapping continuous soil properties using random forests. *Geoderma*, 291, 147-159.
