---
title: "Data Source Integration"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Data Source Integration}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5
)
```

## Overview

Integrate multiple data sources (field observations, SSURGO) and depth-stratified information for improved spatial coverage and parameter stability.

---

## Workflow

### 1. Load and Combine Data

```{r setup_and_load}
library(geocoda)
library(terra)
library(sf)
library(compositions)

# Field observations
field_obs <- data.frame(
  x = c(10, 30, 50, 70, 90),
  y = c(20, 40, 60, 80, 85),
  depth_cm = 10,
  SAND = c(55, 48, 35, 42, 60),
  SILT = c(30, 38, 45, 40, 25),
  CLAY = c(15, 14, 20, 18, 15),
  weight = 1.0
)

# SSURGO-derived estimates (lower weight)
ssurgo_data <- data.frame(
  x = c(20, 40, 60, 80),
  y = c(30, 50, 70, 90),
  depth_cm = 10,
  SAND = c(50, 45, 38, 40),
  SILT = c(35, 40, 42, 38),
  CLAY = c(15, 15, 20, 22),
  weight = 0.5
)

combined_data <- rbind(
  cbind(field_obs, source = "field"),
  cbind(ssurgo_data, source = "ssurgo")
)

nrow(combined_data)
```

### 2. Weight Components by Quality

```{r weighting}
weight_components <- function(data) {
  # Field observations get higher weight
  data$SAND_w <- data$SAND * ifelse(data$source == "field", 1.0, 0.7)
  data$SILT_w <- data$SILT * ifelse(data$source == "field", 1.0, 0.7)
  data$CLAY_w <- data$CLAY * ifelse(data$source == "field", 1.0, 0.5)
  
  # Renormalize to 100%
  total_w <- data$SAND_w + data$SILT_w + data$CLAY_w
  data$SAND_wt <- (data$SAND_w / total_w) * 100
  data$SILT_wt <- (data$SILT_w / total_w) * 100
  data$CLAY_wt <- (data$CLAY_w / total_w) * 100
  
  return(data)
}

weighted_data <- weight_components(combined_data)
head(weighted_data[, c("source", "SAND", "SAND_wt")])
```

### 3. Build ILR Parameters

```{r ilr_params}
ilr_params <- gc_ilr_params(
  weighted_data[, c("SAND_wt", "SILT_wt", "CLAY_wt")]
)

ilr_params$mean
```

### 4. Fit Variogram

```{r variogram}
library(gstat)

obs_sf <- st_as_sf(
  weighted_data[, c("x", "y", "SAND_wt", "SILT_wt", "CLAY_wt")],
  coords = c("x", "y"), crs = NA
)

obs_ilr <- ilr(acomp(
  weighted_data[, c("SAND_wt", "SILT_wt", "CLAY_wt")]
))
colnames(obs_ilr) <- c("ilr1", "ilr2")

vgm_data <- data.frame(
  x = weighted_data$x,
  y = weighted_data$y,
  ilr1 = obs_ilr[, 1],
  ilr2 = obs_ilr[, 2]
)

vgm_integrated <- gc_fit_vgm(ilr_params, data = vgm_data)
vgm_integrated$map1$psill
```

### 5. Simulate

```{r simulate}
pred_grid <- expand.grid(
  x = seq(0, 100, by = 10),
  y = seq(0, 100, by = 10)
)
pred_grid_sf <- st_as_sf(pred_grid, coords = c("x", "y"), crs = NA)

model <- gc_ilr_model(ilr_params, variogram_model = vgm_integrated)

sims <- gc_sim_composition(
  model = model,
  locations = pred_grid_sf,
  nsim = 3,
  target_names = c("SAND", "SILT", "CLAY")
)

names(sims)
```

---

## Depth Stratification

Build separate models for each soil horizon:

```{r depth_stratified}
prepare_by_depth <- function(data, depth_range) {
  data_sub <- data[data$depth_cm >= depth_range[1] & 
                   data$depth_cm < depth_range[2], ]
  if (nrow(data_sub) > 2) {
    return(gc_ilr_params(data_sub[, c("SAND_wt", "SILT_wt", "CLAY_wt")]))
  }
  NULL
}

# Define depth slices
depths_list <- list(
  "A" = c(0, 10),
  "B" = c(10, 30),
  "C" = c(30, 60)
)

# Extract parameters for each depth
ilr_by_depth <- lapply(depths_list, 
                       function(d) prepare_by_depth(weighted_data, d))

# Build models for each depth
models_by_depth <- lapply(ilr_by_depth, function(p) {
  if (!is.null(p)) {
    vgm <- gc_vgm_defaults(p, extent = c(0, 0, 100, 100))
    gc_ilr_model(p, 
                 vgm(psill = vgm$mean_sill, "Exp", 
                     range = vgm$range, nugget = vgm$nugget))
  }
})
```

---

## Live SSURGO Query

Query SSURGO directly (requires internet and soilDB package):

```{r ssurgo_direct, eval=FALSE}
# library(soilDB)

study_area <- st_bbox(c(xmin = 0, ymin = 0, xmax = 100, ymax = 100), crs = NA)

ssurgo_live <- gc_prepare_ssurgo_direct(
  extent = study_area,
  component_names = c("SAND", "SILT", "CLAY"),
  depth_slices = c("0-10", "10-30", "30-60"),
  use_cache = TRUE,
  timeout = 60
)
```

---

## Key points

[OK] Combine field observations + SSURGO for spatial coverage
[OK] Weight components by data source reliability
[OK] Depth stratification captures horizon-specific variation
[OK] Multi-source data improves parameter stability
[OK] Live queries reduce manual preparation

---

## References

- `?gc_ilr_params()` -- ILR parameter estimation
- `?gc_fit_vgm()` -- Variogram fitting
- `?gc_ilr_model()` -- Model specification
