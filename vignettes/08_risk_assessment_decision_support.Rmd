---
title: "Risk Assessment and Decision Support in Soil Mapping"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Risk Assessment and Decision Support}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5,
  eval = FALSE  # Set to TRUE to run examples
)
```

## Introduction

Geostatistical simulation generates multiple equally-probable realizations of spatial properties, capturing uncertainty. But **how do we make decisions with that uncertainty?**

This vignette demonstrates how to translate simulations into actionable information:

- **Probability maps**: Where does my property exceed critical thresholds?
- **Percentile maps**: What are conservative/optimistic estimates?
- **Risk assessment**: What are the financial consequences of different decisions?
- **Carbon audits**: How many credits can I issue with confidence?

---

## Overview: From Simulation to Decision

### Typical Workflow

```
Geostatistical Model
        ↓
Multiple Realizations (SGS/DBS)
        ↓
Risk Assessment Functions
        ↓
Probability Maps, Percentiles, Loss Analysis
        ↓
Decision & Action
```

### Key Concepts

**Probability of Exceeding**: P(SOC > 50 Mg/ha) at each location
- High probability (>0.8) = confident the threshold is exceeded
- Low probability (<0.2) = confident it's not exceeded
- Medium probability (0.3-0.7) = uncertain

**Percentile Maps**: Conservative and optimistic bounds
- **P10 (10th percentile)**: Conservative low (90% confident actual ≥ this value)
- **P50 (median)**: Best estimate of central value
- **P90 (90th percentile)**: Conservative high (10% confident actual ≥ this value)

**Loss Functions**: Asymmetric costs for different errors
- False positives and false negatives have different consequences
- Decision rule: Minimize expected loss

---

## Part 1: Probability Mapping

### Example: Carbon Credit Eligibility

**Scenario**: Verify soil organic carbon (SOC) stocks for carbon credit issuance. Minimum requirement: 50 Mg/ha.

```{r probability_example, eval = FALSE}
library(geocoda)
library(terra)

# Assume we have simulated SOC realizations (1000 simulations)
# (from previous `gc_sim_composition()` call)
soc_simulations <- terra::rast("carbon_realizations_1000.tif")

# Step 1: Compute probability of exceeding credit threshold
prob_eligible <- gc_probability_map(
  simulations = soc_simulations,
  threshold = 50,
  operator = ">"
)

# Step 2: Visualize
terra::plot(prob_eligible, main = "P(SOC > 50 Mg/ha)")

# Step 3: Summary statistics
prob_values <- terra::values(prob_eligible)
cat("Mean probability:", round(mean(prob_values, na.rm = TRUE), 2), "\n")
cat("Std dev:", round(sd(prob_values, na.rm = TRUE), 2), "\n")
cat("Min:", round(min(prob_values, na.rm = TRUE), 2), "\n")
cat("Max:", round(max(prob_values, na.rm = TRUE), 2), "\n")
```

### Interpretation

- **Green areas (P ≈ 1.0)**: Highly confident SOC > 50 Mg/ha
- **Red areas (P ≈ 0)**: Highly confident SOC < 50 Mg/ha
- **Yellow areas (P ≈ 0.5)**: Maximum uncertainty about threshold

### Multiple Operators

```{r operators, eval = FALSE}
# Different threshold comparisons
prob_above_50 <- gc_probability_map(soc_sims, threshold = 50, operator = ">")
prob_below_50 <- gc_probability_map(soc_sims, threshold = 50, operator = "<")
prob_equal_50 <- gc_probability_map(soc_sims, threshold = 50, operator = "==")

# These should be complementary:
# P(Z > t) + P(Z <= t) ≈ 1
all_equal <- prob_above_50 + prob_below_50
terra::global(all_equal, "sum")  # Should be ~n_pixels
```

---

## Part 2: Percentile Mapping

### Standard Uncertainty Band

```{r percentiles, eval = FALSE}
# Compute P10, P50, P90 (standard uncertainty quantification)
percentiles_map <- gc_percentile_map(
  simulations = soc_simulations,
  percentiles = c(0.1, 0.5, 0.9),
  names_format = "P{p}"
)

# Result: 3-layer raster (P10, P50, P90)
terra::plot(percentiles_map, main = c("Conservative (P10)", "Median (P50)", "Optimistic (P90)"))

# Extract specific layers
p10 <- percentiles_map$P0.1  # Conservative low
p50 <- percentiles_map$P0.5  # Central estimate
p90 <- percentiles_map$P0.9  # Conservative high

# Compute uncertainty band width
uncertainty_width <- p90 - p10
terra::plot(uncertainty_width, main = "P90 - P10 Uncertainty Width")
```

### Custom Percentiles

```{r custom_percentiles, eval = FALSE}
# Fine-grained percentiles (quartiles)
quartiles <- gc_percentile_map(
  soc_simulations,
  percentiles = c(0.25, 0.5, 0.75),
  names_format = "Q{p*100}"
)
# Result: Q25, Q50, Q75

# For regulatory compliance (very conservative)
regulatory <- gc_percentile_map(
  soc_simulations,
  percentiles = c(0.05, 0.95)  # 5th and 95th percentiles
)
```

### Application: Management Zones

```{r management_zones, eval = FALSE}
# Use percentiles to define management zones
p50 <- percentiles_map$P0.5
p90 <- percentiles_map$P0.9

# High-performing zone: P90 > 60
high_perf <- p90 > 60

# Medium zone: 50 < P50 < 60
medium_zone <- (p50 > 50) & (p50 < 60)

# Low-performing zone: P10 < 50
low_perf <- (percentiles_map$P0.1) < 50

# Classify
zones <- terra::classify(
  c(high_perf, medium_zone, low_perf),
  matrix(c(0, 0.5, 1, 1.5, 2, 2.5), nrow = 3, byrow = TRUE)
)

terra::plot(zones, main = "Management Zones")
```

---

## Part 3: Risk Assessment with Loss Functions

### Carbon Credit Case: Asymmetric Costs

**Scenario**: Over-issuing credits costs program money (reputational risk, refunds). Under-issuing costs opportunity (foregone revenue from buyers). Costs are different!

```{r risk_assessment, eval = FALSE}
# Carbon credit decision with asymmetric costs
# a = cost of false positive (over-crediting): $2 per unit risk
# b = cost of false negative (under-crediting): $1 per unit opportunity cost
carbon_risk <- gc_risk_assessment(
  simulations = soc_simulations,
  threshold = 50,  # Credit threshold
  loss_function = "asymmetric",
  cost_params = list(a = 2, b = 1),
  operator = "<"  # Loss if SOC < 50
)

# Visualize expected loss
terra::plot(carbon_risk$expected_loss, main = "Expected Loss ($)")
terra::plot(carbon_risk$decision, main = "Optimal Decision (1=Accept, 0=Reject)")

# Summary
mean_loss <- mean(terra::values(carbon_risk$expected_loss), na.rm = TRUE)
cat("Mean expected loss: $", round(mean_loss, 2), "\n")
```

### Loss Function Options

```{r loss_functions, eval = FALSE}
# Linear (symmetric): Loss proportional to distance from threshold
linear_loss <- gc_risk_assessment(
  soc_simulations,
  threshold = 50,
  loss_function = "linear",
  cost_params = list(a = 1, b = 1)  # Equal costs
)

# Asymmetric (two-sided): Different costs for under vs. over
asymmetric_loss <- gc_risk_assessment(
  soc_simulations,
  threshold = 50,
  loss_function = "asymmetric",
  cost_params = list(a = 2, b = 1)  # Over-estimate costs 2x
)

# Step (binary): Fixed cost if threshold crossed
step_loss <- gc_risk_assessment(
  soc_simulations,
  threshold = 50,
  loss_function = "step",
  cost_params = list(a = 100, b = 50)  # Fixed costs
)

# Custom function (advanced)
my_loss <- function(z, threshold, cost_params) {
  # Custom logic...
  ifelse(z < threshold, cost_params$a * (threshold - z)^2, 0)
}

custom_loss <- gc_risk_assessment(
  soc_simulations,
  threshold = 50,
  loss_function = my_loss,
  cost_params = list(a = 1)
)
```

---

## Part 4: Carbon Audit Workflow

### Complete Audit Procedure

```{r carbon_audit, eval = FALSE}
# Comprehensive carbon stock audit with conservative estimates
audit_result <- gc_carbon_audit(
  simulations = soc_simulations,
  credit_threshold = 50,  # Minimum SOC for credit
  confidence = 0.90,      # 90% confidence level
  audit_type = "conservative"  # Use P10 for credit issuance
)

# Print human-readable audit report
cat(audit_result$audit_report)

# Access individual components
prob_map <- audit_result$probability_map
conservative_est <- audit_result$conservative_estimate
credit_approved <- audit_result$issued_credit
summary_stats <- audit_result$summary

# Visualize results
par(mfrow = c(2, 2))
terra::plot(prob_map, main = "Probability SOC > 50 Mg/ha")
terra::plot(conservative_est, main = "P10 Estimate (90% Confidence)")
terra::plot(credit_approved, main = "Credit Approved?")
plot(summary_stats$metric, summary_stats$value, type = "h",
     main = "Audit Summary")
```

### Audit Types

```{r audit_types, eval = FALSE}
# Conservative: Use P10 (10th percentile, 90% sure actual > this value)
audit_cons <- gc_carbon_audit(
  soc_simulations,
  credit_threshold = 50,
  confidence = 0.9,
  audit_type = "conservative"  # Most restrictive
)

# Expected: Use P50 (median, 50% sure actual > this value)
audit_exp <- gc_carbon_audit(
  soc_simulations,
  credit_threshold = 50,
  confidence = 0.9,
  audit_type = "expected"  # Balanced
)

# Optimistic: Use P90 (90th percentile, 10% sure actual > this value)
audit_opt <- gc_carbon_audit(
  soc_simulations,
  credit_threshold = 50,
  confidence = 0.9,
  audit_type = "optimistic"  # Most generous
)

# Compare results
conservative_credits <- audit_cons$summary$value[6]
expected_credits <- audit_exp$summary$value[6]
optimistic_credits <- audit_opt$summary$value[6]

cat("Conservative:", conservative_credits, "credits\n")
cat("Expected:", expected_credits, "credits\n")
cat("Optimistic:", optimistic_credits, "credits\n")
```

---

## Part 5: Real-World Application: Contamination Remediation

### Decision: Clean or Not?

```{r contamination, eval = FALSE}
# Lead (Pb) contamination: 300 mg/kg is the remediation threshold
# Over-cleaning (false positive): Expensive excavation of safe soil
# Under-cleaning (false negative): Health risk, liability

lead_sims <- terra::rast("lead_realizations.tif")

remediation_decision <- gc_risk_assessment(
  simulations = lead_sims,
  threshold = 300,  # mg/kg limit
  loss_function = "asymmetric",
  cost_params = list(
    a = 10,  # Cost of over-remediation ($10k per 1 mg/kg risk)
    b = 50   # Cost of under-remediation ($50k liability per 1 mg/kg risk)
  ),
  operator = ">"  # Loss if Pb > 300
)

# Decision map
terra::plot(remediation_decision$decision,
            main = "Remediation Decision (1=Remediate, 0=Safe)")

# High-risk areas
high_risk <- remediation_decision$expected_loss > quantile(terra::values(remediation_decision$expected_loss), 0.75, na.rm = TRUE)
terra::plot(high_risk, main = "High-Risk Areas (Top 25% Loss)")
```

---

## Part 6: Integration with Other geocoda Functions

### Full Workflow Example

```{r full_workflow, eval = FALSE}
library(geocoda)
library(terra)

# 1. Data preparation
soil_data <- data.frame(
  x = c(0, 100, 200, 300),
  y = c(0, 100, 200, 300),
  sand = c(40, 50, 45, 55),
  silt = c(35, 30, 40, 25),
  clay = c(25, 20, 15, 20)
)

# 2. ILR transformation
ilr_data <- gc_transform_ilr(soil_data[, c("sand", "silt", "clay")])
soil_data$ilr1 <- ilr_data$ilr1
soil_data$ilr2 <- ilr_data$ilr2

# 3. Geostatistical modeling
coords <- cbind(soil_data$x, soil_data$y)
model <- gc_ilr_model(soil_data, coords, components = c("ilr1", "ilr2"))

# 4. Simulate
extent <- c(0, 400, 0, 400)
sims <- gc_sim_composition(
  soil_data, model, extent = extent, resolution = 50, nsim = 100
)

# 5. Risk assessment
prob_sand <- gc_probability_map(sims, threshold = 50, component = "sand", operator = ">")
perc_clay <- gc_percentile_map(sims)
audit <- gc_carbon_audit(sims, credit_threshold = 40, confidence = 0.9)

# 6. Visualize all together
par(mfrow = c(2, 2))
terra::plot(prob_sand, main = "P(Sand > 50%)")
terra::plot(perc_clay$P0.5, main = "Median Clay %")
terra::plot(audit$probability_map, main = "P(SOC > 40 Mg/ha)")
terra::plot(audit$issued_credit, main = "Credit Approved")
```

---

## Troubleshooting

### Issue: All Probabilities Close to 0 or 1

**Cause**: Threshold is far from data distribution (very high/low confidence)

**Solution**: Review threshold choice relative to data range
```{r troubleshoot_1, eval = FALSE}
# Check data range
range(terra::values(sims), na.rm = TRUE)

# Adjust threshold to meaningful percentile
p75 <- quantile(terra::values(sims), 0.75, na.rm = TRUE)
prob_adjusted <- gc_probability_map(sims, threshold = p75, operator = ">")
```

### Issue: Inconsistent Audit Results Across Realizations

**Cause**: Natural variation in realizations (expected!)

**Solution**: Increase number of simulations for stability
```{r troubleshoot_2, eval = FALSE}
# With 100 realizations, ~10% variation in percentiles is normal
# Use 1000+ realizations for critical decisions

sims_stable <- gc_sim_composition(data, model, extent, resolution, nsim = 1000)
audit_stable <- gc_carbon_audit(sims_stable, credit_threshold = 50)
```

### Issue: Credit Areas Are Too Small

**Cause**: Conservative estimate (P10) is below threshold in most areas

**Solution**: Consider less conservative audit type or lower threshold
```{r troubleshoot_3, eval = FALSE}
# If conservative audit gives 0% eligible area, try expected or optimistic
audit_exp <- gc_carbon_audit(
  sims,
  credit_threshold = 50,
  confidence = 0.9,
  audit_type = "expected"  # Uses P50 instead of P10
)

# Or lower threshold based on project objectives
audit_lower <- gc_carbon_audit(
  sims,
  credit_threshold = 40,  # Lower threshold
  confidence = 0.9,
  audit_type = "conservative"
)
```

---

## Summary & Best Practices

### Key Takeaways

1. **Probability maps** show where thresholds are likely exceeded
2. **Percentile maps** provide conservative/optimistic bounds
3. **Risk assessment** optimizes decisions under asymmetric costs
4. **Audits** generate decision-ready reports with confidence bounds

### Best Practices

✓ **Use P10-P90** for standard uncertainty bands
✓ **Match loss function** to your real-world costs
✓ **Document confidence levels** in audit reports
✓ **Review outlier pixels** (very high/low probability)
✓ **Use ensemble validation** (cross-validation on test set)
✓ **Iterate with stakeholders** on acceptable risk levels

### When to Use Each Function

| Function | Best For |
|----------|----------|
| `gc_probability_map()` | Binary decisions (above/below threshold) |
| `gc_percentile_map()` | Uncertainty visualization & conservative estimates |
| `gc_risk_assessment()` | Optimal decisions under cost uncertainty |
| `gc_carbon_audit()` | Carbon credit verification (specialized wrapper) |

---

## References

- Goovaerts, P. (1997). Geostatistics for Natural Resources Evaluation. Oxford University Press.
- Goovaerts, P. (2001). Geostatistical modelling of uncertainty in soil science. *Geoderma*, 103(1-2), 3-26.
- Journel, A. G., & Isaaks, E. H. (1984). Conditional indicator simulation. *Mathematical Geology*, 16(7), 685-718.
- Bishop, T. F., Minasny, B., & McBratney, A. B. (2018). Uncertainties in digital soil mapping. *In Digital Soil Assessment and Beyond* (pp. 241-258).

---

## See Also

- `gc_sim_composition()` - Generate simulation realizations
- `gc_ilr_model()` - Fit geostatistical models
- `gc_fit_hierarchical_model()` - Hierarchical Bayesian modeling
- `gc_validate_ensemble()` - Cross-validation of results
